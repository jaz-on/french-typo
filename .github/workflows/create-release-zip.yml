name: Create Release ZIP

on:
  # Ne pas créer de release/ZIP sur simple push de tag pour éviter les publications non désirées
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag à builder (ex: 1.0.0 ou v1.0.0)'
        required: false
      deploy_to_wporg:
        description: 'Déployer sur WordPress.org via 10up/action-wordpress-plugin-deploy ?'
        required: false
        default: 'false'

jobs:
  create-zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            # workflow_dispatch
            if [ -n "${{ github.event.inputs.tag }}" ]; then
              echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            else
              echo "No tag provided via workflow_dispatch input 'tag'"
              exit 1
            fi
          fi
        shell: bash

      - name: Setup Node.js (for rsync alternative)
        uses: actions/setup-node@v4

      - name: Install dependencies for zip creation
        run: |
          sudo apt-get update
          sudo apt-get install -y zip rsync

      - name: Create clean distribution directory
        run: |
          mkdir -p dist/french-typo
          
      - name: Copy files excluding .distignore patterns
        run: |
          # Read .distignore and create rsync exclude file
          grep -v '^#' .distignore | grep -v '^$' | sed 's|^|--exclude=|' > /tmp/excludes.txt
          echo "--exclude=.git" >> /tmp/excludes.txt
          echo "--exclude=dist" >> /tmp/excludes.txt
          
          # Copy files using rsync with exclusions
          rsync -av \
            $(cat /tmp/excludes.txt | tr '\n' ' ') \
            ./ dist/french-typo/

      - name: Create plugin ZIP file (distribution)
        run: |
          cd dist
          zip -r ../french-typo-${{ steps.get_tag.outputs.TAG }}.zip french-typo/
          cd ..

      - name: Create source ZIP file (for WordPress.org review)
        run: |
          # Créer un ZIP sources avec tous les fichiers du repo (sauf .git, node_modules, etc.)
          # Ce ZIP est utile pour la review WordPress.org
          git archive --format=zip --output=french-typo-${{ steps.get_tag.outputs.TAG }}-source.zip HEAD

      - name: Verify plugin ZIP contents
        run: |
          echo "=== Plugin ZIP Contents ==="
          unzip -l french-typo-${{ steps.get_tag.outputs.TAG }}.zip | head -20
          echo ""
          echo "=== Checking for excluded files ==="
          if unzip -l french-typo-${{ steps.get_tag.outputs.TAG }}.zip | grep -E "(composer\.json|README\.md|TODO\.md|\.github|assets/|\.distignore)"; then
            echo "❌ ERROR: Excluded files found in plugin ZIP!"
            exit 1
          else
            echo "✅ Plugin ZIP is clean - no excluded files found"
          fi

      - name: Verify source ZIP exists
        run: |
          if [ ! -f french-typo-${{ steps.get_tag.outputs.TAG }}-source.zip ]; then
            echo "❌ ERROR: Source ZIP not created!"
            exit 1
          else
            echo "✅ Source ZIP created: french-typo-${{ steps.get_tag.outputs.TAG }}-source.zip"
            unzip -l french-typo-${{ steps.get_tag.outputs.TAG }}-source.zip | head -10
          fi

      - name: Upload ZIPs to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            french-typo-${{ steps.get_tag.outputs.TAG }}.zip
            french-typo-${{ steps.get_tag.outputs.TAG }}-source.zip
          tag_name: ${{ steps.get_tag.outputs.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
          # Respecter le statut draft de la release si elle existe, sinon créer en draft
          draft: ${{ github.event_name == 'release' && github.event.release.draft || 'true' }}
          prerelease: false

      - name: Summary
        run: |
          echo "## ✅ Release ZIPs Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Two ZIP files have been created and attached to the release:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Plugin ZIP:** \`french-typo-${{ steps.get_tag.outputs.TAG }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Clean distribution package (excludes dev files via .distignore)" >> $GITHUB_STEP_SUMMARY
          echo "   - Ready for WordPress.org submission" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Source ZIP:** \`french-typo-${{ steps.get_tag.outputs.TAG }}-source.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Complete source code archive (git archive)" >> $GITHUB_STEP_SUMMARY
          echo "   - Useful for WordPress.org review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "**Release status:** ${{ github.event.release.draft && 'Draft' || 'Published' }}" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-to-wporg:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_wporg == 'true' }}
    needs: create-zip
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag (from dispatch input)
        id: tag
        run: |
          if [ -z "${{ github.event.inputs.tag }}" ]; then
            echo "No tag provided for deploy"; exit 1;
          fi
          echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Verify Stable tag matches readme.txt
        run: |
          STABLE=$(grep -E '^Stable tag:' readme.txt | awk -F': ' '{print $2}' | tr -d ' \t')
          TAG="${{ steps.tag.outputs.TAG }}"
          TAG="${TAG#v}"
          echo "Stable tag in readme.txt: $STABLE"
          echo "Tag to deploy: $TAG"
          if [ "$STABLE" != "$TAG" ]; then
            echo "Stable tag ($STABLE) does not match tag to deploy ($TAG)"; exit 1;
          fi

      - name: Summary - Deploy guard info
        run: |
          echo "## Manual deploy to WordPress.org - Guard Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: \`${{ steps.tag.outputs.TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Stable tag matches readme.txt ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next step: Configure and enable 10up/action-wordpress-plugin-deploy when SVN is ready." >> $GITHUB_STEP_SUMMARY
          echo "Docs: https://github.com/10up/action-wordpress-plugin-deploy" >> $GITHUB_STEP_SUMMARY

      # Placeholder. Uncomment when SVN and secrets are ready.
      # - name: Deploy to WordPress.org
      #   uses: 10up/action-wordpress-plugin-deploy@stable
      #   with:
      #     svn_username: ${{ secrets.SVN_USERNAME }}
      #     svn_password: ${{ secrets.SVN_PASSWORD }}
      #     slug: ${{ secrets.SLUG }}
      #     # Optional: assets-dir defaults to .wordpress-org
      #     # assets_dir: .wordpress-org
      #     # version: ${{ steps.tag.outputs.TAG }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

