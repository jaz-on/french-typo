name: Create Release ZIP

on:
  # Do not create release/ZIP on simple tag push to avoid unintended publications
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g. 1.0.0 or v1.0.0)'
        required: false
      deploy_to_wporg:
        description: 'Deploy to WordPress.org via 10up/action-wordpress-plugin-deploy?'
        required: false
        default: 'false'

jobs:
  create-zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            # workflow_dispatch
            if [ -n "${{ github.event.inputs.tag }}" ]; then
              echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            else
              echo "No tag provided via workflow_dispatch input 'tag'"
              exit 1
            fi
          fi
        shell: bash

      - name: Checkout tag (to freeze code state)
        run: |
          TAG="${{ steps.get_tag.outputs.TAG }}"
          echo "Checking out tag: $TAG"
          git checkout "refs/tags/$TAG" || git checkout "$TAG"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Tag points to: $(git rev-parse $TAG^{})"

      - name: Install dependencies for zip creation
        run: |
          sudo apt-get update
          sudo apt-get install -y zip rsync

      - name: Create clean distribution directory
        run: |
          mkdir -p dist/french-typo
          
      - name: Copy files excluding .distignore patterns
        run: |
          # Read .distignore and create rsync exclude file
          grep -v '^#' .distignore | grep -v '^$' | sed 's|^|--exclude=|' > /tmp/excludes.txt
          echo "--exclude=.git" >> /tmp/excludes.txt
          echo "--exclude=dist" >> /tmp/excludes.txt
          
          # Copy files using rsync with exclusions
          rsync -av \
            $(cat /tmp/excludes.txt | tr '\n' ' ') \
            ./ dist/french-typo/

      - name: Create plugin ZIP file (distribution)
        run: |
          cd dist
          zip -r ../french-typo-${{ steps.get_tag.outputs.TAG }}.zip french-typo/
          cd ..

      - name: Verify plugin ZIP contents
        run: |
          echo "=== Plugin ZIP Contents ==="
          unzip -l french-typo-${{ steps.get_tag.outputs.TAG }}.zip | head -20
          echo ""
          echo "=== Checking for excluded files ==="
          if unzip -l french-typo-${{ steps.get_tag.outputs.TAG }}.zip | grep -E "(composer\.json|README\.md|TODO\.md|\.github|assets/|\.distignore)"; then
            echo "❌ ERROR: Excluded files found in plugin ZIP!"
            exit 1
          else
            echo "✅ Plugin ZIP is clean - no excluded files found"
          fi

      - name: Upload ZIP to release
        uses: softprops/action-gh-release@v1
        with:
          files: french-typo-${{ steps.get_tag.outputs.TAG }}.zip
          tag_name: ${{ steps.get_tag.outputs.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
          # Preserve the draft status if the release exists, otherwise create as draft
          draft: ${{ github.event_name == 'release' && github.event.release.draft || 'true' }}
          prerelease: false

      - name: Summary
        run: |
          echo "## ✅ Release ZIP Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A clean distribution ZIP has been created and attached to the release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`french-typo-${{ steps.get_tag.outputs.TAG }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This ZIP contains only the essential files for WordPress.org submission (excludes dev files via .distignore)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "**Release status:** ${{ github.event.release.draft && 'Draft' || 'Published' }}" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-to-wporg:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_wporg == 'true' }}
    needs: create-zip
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag (from dispatch input)
        id: tag
        run: |
          if [ -z "${{ github.event.inputs.tag }}" ]; then
            echo "No tag provided for deploy"; exit 1;
          fi
          echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Verify Stable tag matches readme.txt
        run: |
          STABLE=$(grep -E '^Stable tag:' readme.txt | awk -F': ' '{print $2}' | tr -d ' \t')
          TAG="${{ steps.tag.outputs.TAG }}"
          TAG="${TAG#v}"
          echo "Stable tag in readme.txt: $STABLE"
          echo "Tag to deploy: $TAG"
          if [ "$STABLE" != "$TAG" ]; then
            echo "Stable tag ($STABLE) does not match tag to deploy ($TAG)"; exit 1;
          fi

      - name: Summary - Deploy guard info
        run: |
          echo "## Manual deploy to WordPress.org - Guard Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: \`${{ steps.tag.outputs.TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Stable tag matches readme.txt ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next step: Configure and enable 10up/action-wordpress-plugin-deploy when SVN is ready." >> $GITHUB_STEP_SUMMARY
          echo "Docs: https://github.com/10up/action-wordpress-plugin-deploy" >> $GITHUB_STEP_SUMMARY

      # Placeholder. Uncomment when SVN and secrets are ready.
      # - name: Deploy to WordPress.org
      #   uses: 10up/action-wordpress-plugin-deploy@stable
      #   with:
      #     svn_username: ${{ secrets.SVN_USERNAME }}
      #     svn_password: ${{ secrets.SVN_PASSWORD }}
      #     slug: ${{ secrets.SLUG }}
      #     # Optional: assets-dir defaults to .wordpress-org
      #     # assets_dir: .wordpress-org
      #     # version: ${{ steps.tag.outputs.TAG }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

