name: Create Release ZIP

on:
  # Do not create release/ZIP on simple tag push to avoid unintended publications
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g. 1.0.0 or v1.0.0)'
        required: false
      deploy_to_wporg:
        description: 'Deploy to WordPress.org via 10up/action-wordpress-plugin-deploy?'
        required: false
        default: 'false'

jobs:
  create-zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Get tag
        id: tag
        run: |
          TAG="${{ github.event_name == 'release' && github.event.release.tag_name || github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then
            echo "❌ No tag provided"
            exit 1
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - name: Create ZIP
        run: |
          # Install dependencies
          sudo apt-get install -y zip rsync
          
          # Build exclude list from .distignore
          grep -v '^#' .distignore | grep -v '^$' | sed 's|^|--exclude=|' > /tmp/excludes.txt
          echo "--exclude=.git" >> /tmp/excludes.txt
          echo "--exclude=dist" >> /tmp/excludes.txt
          
          # Copy files excluding .distignore patterns
          mkdir -p dist/french-typo
          rsync -av $(cat /tmp/excludes.txt | tr '\n' ' ') ./ dist/french-typo/
          
          # Create ZIP
          cd dist && zip -r ../french-typo-${{ steps.tag.outputs.tag }}.zip french-typo/

      - name: Verify ZIP exists
        run: |
          test -f french-typo-${{ steps.tag.outputs.tag }}.zip || (echo "❌ ZIP file not created" && exit 1)
          echo "✅ ZIP created: french-typo-${{ steps.tag.outputs.tag }}.zip"

      - name: Upload ZIP to release
        uses: softprops/action-gh-release@v1
        with:
          files: french-typo-${{ steps.tag.outputs.tag }}.zip
          tag_name: ${{ steps.tag.outputs.tag }}
          draft: ${{ github.event_name == 'release' && github.event.release.draft || 'true' }}
          prerelease: false

  deploy-to-wporg:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_wporg == 'true' }}
    needs: create-zip
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag (from dispatch input)
        id: tag
        run: |
          if [ -z "${{ github.event.inputs.tag }}" ]; then
            echo "No tag provided for deploy"; exit 1;
          fi
          echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT

      - name: Verify Stable tag matches readme.txt
        run: |
          STABLE=$(grep -E '^Stable tag:' readme.txt | awk -F': ' '{print $2}' | tr -d ' \t')
          TAG="${{ steps.tag.outputs.TAG }}"
          TAG="${TAG#v}"
          echo "Stable tag in readme.txt: $STABLE"
          echo "Tag to deploy: $TAG"
          if [ "$STABLE" != "$TAG" ]; then
            echo "Stable tag ($STABLE) does not match tag to deploy ($TAG)"; exit 1;
          fi

      - name: Summary - Deploy guard info
        run: |
          echo "## Manual deploy to WordPress.org - Guard Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: \`${{ steps.tag.outputs.TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Stable tag matches readme.txt ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next step: Configure and enable 10up/action-wordpress-plugin-deploy when SVN is ready." >> $GITHUB_STEP_SUMMARY
          echo "Docs: https://github.com/10up/action-wordpress-plugin-deploy" >> $GITHUB_STEP_SUMMARY

      # Placeholder. Uncomment when SVN and secrets are ready.
      # - name: Deploy to WordPress.org
      #   uses: 10up/action-wordpress-plugin-deploy@stable
      #   with:
      #     svn_username: ${{ secrets.SVN_USERNAME }}
      #     svn_password: ${{ secrets.SVN_PASSWORD }}
      #     slug: ${{ secrets.SLUG }}
      #     # Optional: assets-dir defaults to .wordpress-org
      #     # assets_dir: .wordpress-org
      #     # version: ${{ steps.tag.outputs.TAG }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

